/*! cloud-convert by Adam Timberlake <adam.timberlake@gmail.com> created on 2013-11-06 */
!function(a){"use strict";process.env.NODE_TLS_REJECT_UNAUTHORIZED=0;var b=require("fs"),c=require("js-yaml"),d=require("util"),e=require("request"),f=require("q"),g=require("mime"),h=require("restler"),i=function(){};i.prototype={_urlProcess:"https://api.cloudconvert.org/process?inputformat=%s&outputformat=%s&apikey=%s",_urlActions:{"delete":"delete",cancel:"cancel"},_options:{file:null,from:null,into:null},_task:{id:null,url:null},_apiKey:"",_defaultInterval:2500,_errorCodes:{invalidConfig:1,configKey:2,invalidJobId:3},_callbacks:{uploading:{method:function(){}},uploaded:{method:function(){}},converting:{method:function(){}},finished:{method:function(){}}},when:function(a,b,c){this._callbacks[a]={method:b,interval:c||this._defaultInterval}},convert:function(a){return this._options.file=a,this},from:function(a){return this._options.from=a,this},into:function(a){return this._options.into=a,this},process:function(){b.readFile(__dirname+"/config.yaml","utf-8",function(a,b){try{var d=c.load(b);if(!("apiKey"in d))return this._callbacks.error.method({code:this._errorCodes.configKey,message:'Cannot find "apiKey" in configuration!'}),!1;this._apiKey=d.apiKey,this._convert.apply(this)}catch(e){return this._callbacks.error.method({code:this._errorCodes.invalidConfig,message:"Unable to parse YAML configuration!"}),!1}}.bind(this))},_convert:function(){var a=d.format(this._urlProcess,this._options.from,this._options.into,this._apiKey);this._getContent(a).then(this._prepareConversion.bind(this)).then(this._sendFile.bind(this)).then(this._applyCallbacks.bind(this)).fail(function(a){this._callbacks.error.method(a)}.bind(this))},_prepareConversion:function(a){var b=f.defer();return"id"in a&&(this._task.id=a.id,this._task.url=d.format("https:%s",a.url),b.resolve()),b.reject({code:this._errorCodes.invalidJobId,message:"Cannot determine CloudConvert job ID!"}),b.promise},_sendFile:function(){var a=this._options.file,c=f.defer();return b.stat(a,function(b,d){var e=g.lookup(a),f=d.size;this._callbacks.uploading.method();var i={rejectUnauthorized:!1,multipart:!0,data:{input:"upload",file:h.file(a,null,f,null,e),outputformat:this._options.into}};h.post(this._task.url,i).on("complete",function(a){c.resolve(a)}.bind(this))}.bind(this)),c.promise},_applyCallbacks:function(a){this._callbacks.uploaded.method(a);var b=setInterval(function(){this._getContent(this._task.url).then(function(a){return"finished"===a.step?(this._callbacks.finished.method(a),clearInterval(b),void 0):(this._callbacks.converting.method(a),void 0)}.bind(this))}.bind(this),this._callbacks.converting.interval)},_getContent:function(a){var b=f.defer(),c={url:a,strictSSL:!1};return e(c,function(a,c,d){return a&&200!==c.statusCode?b.reject(a):b.resolve(JSON.parse(d))}),b.promise}},a.exports=i}(module);