/*! cloud-convert by Adam Timberlake <adam.timberlake@gmail.com> created on 2013-11-05 */
!function(a){"use strict";process.env.NODE_TLS_REJECT_UNAUTHORIZED=0;var b=require("fs"),c=require("js-yaml"),d=require("util"),e=require("request"),f=require("q"),g=require("mime"),h=require("restler"),i=function(){};i.prototype={urlProcess:"https://api.cloudconvert.org/process?inputformat=%s&outputformat=%s&apikey=%s",urlActions:{"delete":"delete",cancel:"cancel"},details:{file:null,from:null,into:null},task:{id:null,url:null},apiKey:"",defaultInterval:2500,callbacks:{uploading:null,uploaded:null,converting:null,finished:null},when:function(a,b,c){this.callbacks[a]={method:b,interval:c||this.defaultInterval}},convert:function(a){return this.details.file=a,this},from:function(a){return this.details.from=a,this},into:function(a){return this.details.into=a,this},process:function(){var a=this;b.readFile(__dirname+"/config.yaml","utf-8",function(b,d){a.apiKey=c.load(d).apiKey,a._convert.apply(a)})},_convert:function(){var a=d.format(this.urlProcess,this.details.from,this.details.into,this.apiKey);this._getContent(a).then(this._prepareConversion.bind(this)).then(this._sendFile.bind(this))},_prepareConversion:function(a){var b=f.defer();return"id"in a&&(this.task.id=a.id,this.task.url=d.format("https:%s",a.url),b.resolve()),b.reject(),b.promise},_sendFile:function(){var a=this.task.url,c=this.callbacks,d=this.details.file,e=this.details.into;b.stat(d,function(b,f){var i=g.lookup(d),j=f.size;c.uploading.method();var k={rejectUnauthorized:!1,multipart:!0,data:{input:"upload",file:h.file(d,null,j,null,i),outputformat:e}};h.post(a,k).on("complete",function(b){c.uploaded.method(b);var d=setInterval(function(){this._getContent(a).then(function(a){return"finished"===a.step?(c.finished.method(a),clearInterval(d),void 0):(c.converting.method(a),void 0)}.bind(this))}.bind(this),c.converting.interval)}.bind(this))}.bind(this))},_getContent:function(a){var b=f.defer(),c={url:a,strictSSL:!1};return e(c,function(a,c,d){return a&&200!==c.statusCode?b.reject(a):b.resolve(JSON.parse(d))}),b.promise}},a.exports=i}(module);